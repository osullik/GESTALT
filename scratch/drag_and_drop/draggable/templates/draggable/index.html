<!-- GESTALT-- _____ CENTRIC SEARCH-->

<!-- HTML & CSS (embedded in the <head>)-->
  {% load static %}

    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title></title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    
      <style>
        html {
        height: 100%;
        width: 100%; 
      }

      #regionChoice{
        visibility: hidden;}

        #regionButton{
        visibility: hidden;}

        #objectChoice{
        visibility: hidden;}

        #objectButton{
        visibility: hidden;}

        #textInput{
        visibility: hidden;}

        #textButton{
        visibility: hidden;}

        #submitQueryButton{
        visibility: hidden;}

        #resetButton{
        visibility: hidden;}
    
        .dragBox {
        top: 120px;
        left: 120px;
        padding-top: 5px;
        padding-right: 5px;
        padding-bottom: 5px;
        padding-left: 5px;
        background-color: white;
        position: absolute;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 15px;
        font-family: helvetica;
        font-weight: bold; }
    
        .quadrantsDiv{
        position: absolute;
        top: 54%;
        left: 35%;
        font-size: 40px;
        font-family: helvetica;
        visibility: hidden;}

        .cardinalityImage{
        position: absolute;
        top: 16vh;
        left: calc(10px + 70vw - 10vw);
        visibility: hidden;}

        .locationImage{
        position: absolute;
        top: calc(50% - 44px);
        left: calc(32vw - 8px);
        visibility: hidden;}

        hr {
        position: absolute;
        top: 54%;
        height: 10px;
        left: 1px;
        width: 70vw;
        color: #000000;
        visibility: hidden;}

        vr {
        position: absolute;
        top: 16vh;
        height: 90vh;
        left: 35vw;
        width: 1px; 
        color: #000000;
        visibility: hidden;}

        .resultsLabelDiv{
        background-color: lightgray;
        font-weight: bold;
        color: black;
        padding: 5px;
        width: 400px;
        visibility: hidden;
        }

        .resultsBoxDiv{
        background-color: white;
        width: 400px;
        visibility: hidden;
        }

        #resultsXButton{
        background-color: white;
        padding: 10px;
        visibility: hidden;
        }

        .visible {
        visibility: visible;
        }
        .invisible {
        visibility: hidden;
        }

       

        /* grid container */
        .right-sidebar-grid {
            display:grid;
            grid-template-areas:
                'header'
                'canvas'
                'right-sidebar'
                'footer';
        }

        /* general column padding */
        .right-sidebar-grid > * {
            padding:1rem;
        }

        /* assign columns to grid areas */
        .right-sidebar-grid > .header {
            grid-area:header;
            color: white;
            background:#595959;
        }
        .right-sidebar-grid > .canvas {
            grid-area:canvas;
            background:#fff;
            border-style: solid;
            height:0;
            width:80%;
            padding-bottom:80%;
            background-color:#DACD9F;
        }
        .right-sidebar-grid > .right-sidebar {
            grid-area:right-sidebar;
            background:#B2CD9F;
        }
        .right-sidebar-grid > .footer {
            grid-area:footer;
            background:#72c2f1;
        }

        /* tablet breakpoint */
        @media (min-width:768px) {
            .right-sidebar-grid {
                grid-template-columns:repeat(3, 1fr);
                grid-template-areas:
                    'header header header'
                    'canvas canvas right-sidebar'
                    'footer footer footer';
            }
        }

        .search-type-buttons {
          width: 50%;
          border-radius: 0px;
        }
      </style>
    
    </head>
    
    <body>
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
        
        <div class="right-sidebar-grid">
          <header class="header">
            <h2>GESTALT - Geospatially Enhanced Search with Terrain Augmented Location Targeting
            </h2>
            Select a region to search, 
                  then add objects to the query canvas using the dropdown menu or by typing a query like 
                  'Show me a bus stop East of a crossing and South of a park.'
                  A successful query will return a list of locations in the region matching 
                  the spatial configuration of objects on the query canvas.
           </header>
          <main class="canvas" id="canvasBackground">
            
            <div style="display: flex;">
              <hr id="quadrantsHLine"></hr>
              <vr class="vr" id="quadrantsVLine"></vr>
              <div class="cardinalityImage" id="cardinalityImage">
                   <img src="{% static 'compass_graphic_transparent.png' %}" style="width:10vw;">
              </div>
              <div class="locationImage" id="locationImage">
                   <img src="{% static 'location_marker.png' %}" style="width:7vw;">
              </div>
            </div>
          </main>
        
          <section class="right-sidebar">
             <div style="display:flex; gap:0px; border-bottom: 5px solid transparent;">
                <input type="radio" class="btn-check" name="btnradio" id="objectSearchButton" autocomplete="off" checked>
                <label class="btn btn-outline-light search-type-buttons" for="objectSearchButton">Object Centric Search</label>
                <input type="radio" class="btn-check" name="btnradio" id="locationSearchButton" autocomplete="off">
                <label class="btn btn-outline-light search-type-buttons" for="locationSearchButton">Location Centric Search</label>
             </div>
             
             <div style="display:flex; gap:10px; border-bottom: 30px solid transparent;">
                <input type="checkbox" id="northButton" name="northButton" value="northButton" checked>
                <label for="northButton">I know the query's cardinal orientation</label>
             </div>
             
             <span style="color: black">Select a region to search</span>
             <div style="display:flex; gap:10px; border-bottom: 30px solid transparent;">
                <select name="regionChoice" class="form-select" id="regionChoice"></select>
                <button type="button" class="btn btn-light" name="regionButton" id="regionButton">Set Region</button>
             </div>
             
             <span style="color: black; visibility: hidden;" id="object-instructions">Add objects to the canvas using the dropdown or by typing a description</span>
             <div style="display:flex; gap:10px; border-bottom: 30px solid transparent;">
                <select name="objectChoice" class="form-select" id="objectChoice" style="width: 200px;"></select>
                <button type="button" name="objectButton" class="btn btn-light" id="objectButton">Add Object</button>
                <div>                     </div>
                <input type="text" name="textInput" id="textInput" placeholder="Insert text here..." maxlength="512" style="width: 300px;"></input>
                <button type="button" name="textButton" class="btn btn-light" id="textButton">Go</button>
             </div>
            
             <div style="display:flex; gap:10px; border-bottom: 50px solid transparent;">
                <button type="button" name="submitQueryButton" class="btn btn-success" id="submitQueryButton">Submit Query</button>
                <button type="button" name="resetButton" class="btn btn-danger" id="resetButton">Reset Canvas</button>
             </div>
      
             <div style="display:flex; gap:0px;">
                <div class="resultsLabelDiv rounded" id="resultsLabelDiv">Locations Matching Query:</div>
                <button type="button" name="resultsXButton" class="btn btn-close" id="resultsXButton"></button>
             </div>
             <div class="resultsBoxDiv rounded" id="resultsBoxDiv">
                 <ul id="results-list">
                 </ul>
             </div>
          </section>
          <footer class="footer">Footer</footer>
      
    
    </body>
    </html>
    
    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function(){
          var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
          var boxData = [];
          var objectQuery = {};
          var boxCount = 0;
          var searchType = "Object";
          var queryResponse = "";
          var canvasCenter = {'x':370, 'y':1480};

          class Box {
                constructor(name, x, y) {
                  this.name = name;
                  this.x = x;
                  this.y = y;
                  this.element = this.createBoxElement();
                  this.attachEventListeners();
                }

                createBoxElement() {
                  var box = document.createElement('div');
                  box.classList.add('dragBox');
                  box.classList.add('rounded');
                  box.innerText = this.name.replace("_"," ");
                  //box.innerText = this.name + ': X: ' + this.x + ' Y: ' + this.y; //DEBUG MODE
                  box.style.left = this.x + 'px';
                  box.style.top = this.y + 'px';
                  box.dataset.index = boxCount++;
                  document.body.appendChild(box);
                  return box;
                }

                attachEventListeners() {
                  var offsetX = 0;
                  var offsetY = 0;
                  var isDragging = false;

                  this.element.addEventListener('mousedown', (event) => {
                    offsetX = event.clientX - this.element.offsetLeft;
                    offsetY = event.clientY - this.element.offsetTop;
                    isDragging = true;
                  });

                  document.addEventListener('mousemove', (event) => {
                    if (isDragging) {
                      var x = event.clientX - offsetX;
                      var y = event.clientY - offsetY;
                      this.element.style.left = x + 'px';
                      this.element.style.top = y + 'px';

                      if (this.x === x && this.y === y) {return;}
                      this.x = x;
                      this.y = y;
                    }
                  });

                  document.addEventListener('mouseup', () => {
                    isDragging = false;
                    this.element.innerText = this.name.replace("_"," ");
                    //this.element.innerText = this.name + ': X: ' + this.x + ' Y: ' + this.y; //DEBUG MODE
                  });
                }
              }

          function refreshPage() {
            location.reload();
          }

        function getRegions() {
          return $.ajax({
            type: 'GET',
            url: '/getregions/',
            success: function(response) {
              regions = response['regions'];
            }
          });
				}

        // region dropdown............
        function makeRegionDropdown() {
          getRegions().then(function(response) {
          console.log("Got these regions...");
          console.log(regions);				
       
          // Update the region dropdown menu
          var regionDropdown = document.getElementById('regionChoice');
          for (var i = 0; i < regions.length; i++) {
            var region = document.createElement('option');
            region.value = regions[i];
            region.text = regions[i];
            regionDropdown.add(region);
          }
          regionDropdown.style.visibility = "visible";
          
          // Add region GO button
          var regionButton = document.getElementById('regionButton');
          regionButton.addEventListener('click', 
            function (){
              makeQueryCanvas(document.getElementsByName('regionChoice')[0].value);
            });
          regionButton.addEventListener('click', () => refreshPage);
          //regionButton.addEventListener('click', () => regionButton.disabled = true);
          //regionButton.addEventListener('click', enableSearchButtons);
          regionButton.style.visibility = "visible";
          })
				}  // ............region dropdown

        function makeQueryCanvas(regionChoice) {
          setRegion(displayObjDropdown, regionChoice);
          displayTextInput();
				}

        function setRegion(callback, regionChoice) {
          $.ajax({
            type: 'POST',
            url: '/setregion/',
            data: {'name': regionChoice},
            beforeSend: function(xhr) {
              xhr.setRequestHeader('X-CSRFToken', csrfToken);
            },
            success: function(response) {
						  console.log("setregion done, selected...");
              console.log(regionChoice);
              reset(callback); // resets and then calls displayObjectDropdown
              //enableObjectSelect();
              //enableTextInput();
            }
          });
				}

        function displayObjDropdown() {
          console.log("displayObjectDropdown called...");
          getObjects(enableObjectSelect);
          createInvisibleSubmitButton();
          createInvisibleResetButton();
          createInvisibleSearchButtons();
          createInvisibleXButton();
				}

        function displayTextInput() {
          console.log("displayTextInput called...");
          enableTextInput();
				}

        function removeOptions(selectElement) {
          var i, L = selectElement.options.length - 1;
          for(i = L; i >= 0; i--) {
            selectElement.remove(i);
          }
        }

        function getObjects(callback) {
          $.ajax({
            type: 'GET',
            url: '/getobjs/',
            success: function(response) {
              objects = response['objects'];
              console.log(objects);
              callback(); // calls enableObjectSelect
            }
          });
				}

        function enableObjectSelect() {
          // Update the object dropdown menu
          console.log("enableObjectSelect called...");
          
          var objectInstructions = document.getElementById('object-instructions');
          objectInstructions.style.visibility = "visible";

          var objectDropdown = document.getElementById('objectChoice');
          removeOptions(objectDropdown);

          for (var i = 0; i < objects.length; i++) {
            var object = document.createElement('option');
            object.value = objects[i];
            object.text = objects[i].replace("_"," ");
            objectDropdown.add(object);
          }
          objectDropdown.style.visibility = "visible";

          // Add object GO button
          var objectButton = document.getElementById('objectButton');
          if (objectButton.live != true) {
            objectButton.addEventListener('click', 
              function (){
                makeObject(function() {console.log("added")}, document.getElementsByName('objectChoice')[0].value);
              });
              objectButton.addEventListener('click', () => console.log("obj added"));
              objectButton.addEventListener('click', enableSubmitButton);
              objectButton.addEventListener('click', enableResetButton);
            objectButton.style.visibility = "visible";
            objectButton.live = true;
          }
				}

        function enableTextInput() {
          // Update the text input
          console.log("enableTextInput called...");
          var textInput = document.getElementById('textInput');
         // clear text input like: removeOptions(objectDropdown);

         textInput.style.visibility = "visible";

          // Add text GO button
          var textButton = document.getElementById('textButton');
          if (textButton.live != true) {
            textButton.addEventListener('click', 
              function (){
                callLLM(function() {console.log("called LLM")}, document.getElementById('textInput').value);
              });
              textButton.addEventListener('click', () => console.log("text submitted"));
              textButton.addEventListener('click', enableSubmitButton);
              textButton.addEventListener('click', enableResetButton);
              textButton.style.visibility = "visible";
              textButton.live = true;
              console.log("added event listener to GO");
          }
				}

        function createInvisibleSubmitButton() {
          var submitQueryButton = document.getElementById('submitQueryButton');
          if (submitQueryButton.live != true) {
            submitQueryButton.addEventListener('click', 
              function (){
                submitQuery(function() {console.log("query submit finished")});
              });
              submitQueryButton.live = true;
          }
				}

        function enableSubmitButton() {
          var submitQueryButton = document.getElementById('submitQueryButton');
          submitQueryButton.style.visibility = "visible";
				}

        function createInvisibleResetButton() {
          var resetButton = document.getElementById('resetButton');
          if (resetButton.live != true) {
            resetButton.addEventListener('click', 
              function (){
                reset(function() {console.log("reset finished")});
              })
            resetButton.live = true;
          }
				}

        function enableResetButton() {
          var resetButton = document.getElementById('resetButton');
          resetButton.style.visibility = "visible";
				}

        function createInvisibleSearchButtons() {
          var objectSearchButton = document.getElementById('objectSearchButton');
          var locationSearchButton = document.getElementById('locationSearchButton');

          objectSearchButton.addEventListener('click', 
            function (){
              selectObjectSearch(function() {console.log("search type selection changed to OBJECT")});
            });
          objectSearchButton.live = true;

          locationSearchButton.addEventListener('click', 
            function (){
              selectLocationSearch(function() {console.log("search type selection changed to LOCATION")});
            });

				}


        function selectObjectSearch(callback) {
          searchType = "Object";

          // Remove quadrants display
          var quadrantsVLine = document.getElementById('quadrantsVLine');
          quadrantsVLine.style.visibility = "hidden";
          var quadrantsHLine = document.getElementById('quadrantsHLine');
          quadrantsHLine.style.visibility = "hidden";

          // Remove cardinality image
          var cardinalityImage = document.getElementById('cardinalityImage');
          cardinalityImage.style.visibility = "hidden"
          
          // Remove location marker image
          var locationImage = document.getElementById('locationImage');
          locationImage.style.visibility = "hidden"

          // Allow cardinality choice
          var northButton = document.getElementById('northButton')
          northButton.disabled = false;

          callback();
        }

        function selectLocationSearch(callback) {
          searchType = "Location";

          // Display quadrants
          var quadrantsVLine = document.getElementById('quadrantsVLine');
          quadrantsVLine.style.visibility = "visible";
          var quadrantsHLine = document.getElementById('quadrantsHLine');
          quadrantsHLine.style.visibility = "visible";

          // Display cardinality image
          var cardinalityImage = document.getElementById('cardinalityImage');
          cardinalityImage.style.visibility = "visible";

          // Display location marker
          var locationImage = document.getElementById('locationImage');
          locationImage.style.visibility = "visible";
          

          // Force "knows cardinality" checked box to be checked
          var northButton = document.getElementById('northButton')
          northButton.checked = true;
          northButton.disabled = true;
          callback();
        }

        function randomNumber(min, max) {
          min = Math.ceil(min);
          max = Math.floor(max);
          return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function makeObject(callback, objName) {
          console.log(objName);
          var canvasBackground = document.getElementById('canvasBackground');
          var UL = [Math.round(canvasBackground.getBoundingClientRect().left), Math.round(canvasBackground.getBoundingClientRect().top)];
          var LR = [Math.round(canvasBackground.getBoundingClientRect().right), Math.round(canvasBackground.getBoundingClientRect().bottom)];
          console.log(UL, LR);
          BUFFER_H = 100; // approx max width of box
          BUFFER_V = 25;  // approx height of box
          var newBox = new Box(objName, randomNumber(UL[0], LR[0]-BUFFER_H), randomNumber(UL[1], LR[1]-BUFFER_V));
          boxData.push(newBox);
          callback();
				}

        function makeObjectWithCoords(objName, lat, long) {
          console.log(objName)
          var newBox = new Box(objName, lat, long);
          boxData.push(newBox);
				}

        function callLLM(callback, textContent) {
          console.log(textContent);
          console.log("inside call LLM...");

          $.ajax({
            type: 'POST',
            url: '/setquerytext/',
            data: {'text_value': textContent},
            beforeSend: function(xhr) {
              xhr.setRequestHeader('X-CSRFToken', csrfToken);
            },
            success: function(response) {
						  console.log("setquerytext done, set...");
              console.log(textContent);
              getPictorial(callback);
            }
          });
				}

        function getPictorial(callback) {
          console.log("getting pictorial from llm...");
          $.ajax({
            type: 'GET',
            url: '/getpictorial/',
            success: function(response) {
              queryResponse = response.object_query;
              console.log("pictorial result is")
              console.log(queryResponse); // Print the box data
              for(var key in queryResponse) {
                makeObjectWithCoords(queryResponse[key]['name'], queryResponse[key]['x'], queryResponse[key]['y']);
              }
              callback();
            }
					});
        }

        function setRegion(callback, regionChoice) {
          $.ajax({
            type: 'POST',
            url: '/setregion/',
            data: {'name': regionChoice},
            beforeSend: function(xhr) {
              xhr.setRequestHeader('X-CSRFToken', csrfToken);
            },
            success: function(response) {
						  console.log("setregion done, selected...");
              console.log(regionChoice);
              reset(callback); // resets and then calls displayObjectDropdown
              //enableObjectSelect();
              //enableTextInput();
            }
          });
				}

        function convertQuery(callback) {
          // Turn query boxData into a dictionary
          console.log("converting query")
          objectQuery = {};
          for (var i = 0; i < boxCount; i++) {
            objectQuery[i] = {
              'name':boxData[i].name,
              'x':boxData[i].x,
              'y':boxData[i].y
            };
				  }
          callback();
				}

        function submitQuery(callback) {
          convertQuery(function (){
            sendQuery(function (){
              getResponse(function (){
                showResponse(function (){callback()});
              });
            });
          });
        }
          
        function sendQuery(callback) { 
            $.ajax({type: 'POST',
              url: '/setsearchparams/',
              data: {
                'object_query': JSON.stringify(objectQuery), 
                'canvas_center': JSON.stringify(canvasCenter),
                'search_type': searchType, 
                'knows_cardinality': document.getElementById('northButton').checked,
              },
              beforeSend: function(xhr) {
                xhr.setRequestHeader('X-CSRFToken', csrfToken);
              },
              success: function(response) {
                console.log("setsearchparams was successful")
                console.log(searchType); // Either "Location" or "Object" 
                console.log("User knows north setsearchparams: ", document.getElementById('northButton').checked);
                console.log(objectQuery)
                callback();
              }
            });
          }

        function getResponse(callback) {
          console.log("query posted");
          $.ajax({
            type: 'GET',
            url: '/searchresult/',
            success: function(response) {
              queryResponse = response.locations;
              console.log("searchresult is")
              console.log(queryResponse); // Print the box data
              callback();
            }
					});
        }

        function createInvisibleXButton() {
          var resultsXButton = document.getElementById('resultsXButton');
          resultsXButton.addEventListener('click', 
            function (){
              quitResultsDisplay(function() {console.log("results cleared")});
            }
          );
				}

        function quitResultsDisplay(callback) {
          var resultsBoxDiv = document.getElementById('resultsBoxDiv');
          resultsBoxDiv.style.visibility = "hidden";

          var resultsLabelDiv = document.getElementById('resultsLabelDiv');
          resultsLabelDiv.style.visibility = "hidden";

          var resultsXButton = document.getElementById('resultsXButton');
          resultsXButton.style.visibility = "hidden";
          callback();
        }

        function showResponse(callback) {
          // Results display panel
          var resultsBoxDiv = document.getElementById('resultsBoxDiv');
          const resultsList = document.querySelector('#results-list');
          queryResponse = queryResponse.sort()

						for (i in queryResponse) {
              const listItem = document.createElement('li');
              const link = document.createElement('a');
              link.setAttribute('href', 'https://www.openstreetmap.org/node/1727229681#map=19/38.805861/-77.052285')
              link.innerText = queryResponse[i];

              listItem.appendChild(link);
              resultsList.appendChild(listItem);
						}
          resultsBoxDiv.style.visibility = "visible";

          // Label results display
          var resultsLabelDiv = document.getElementById('resultsLabelDiv');
          resultsLabelDiv.style.visibility = "visible";

          // X to close results display
          var resultsXButton = document.getElementById('resultsXButton');
          resultsXButton.style.visibility = "visible";
          callback();
				}

        function reset(callback) {
          console.log("resetting....");
          for (var i = 0; i < boxCount; i++) {
            boxData[i].element.style.visibility = "hidden";
				  }
          boxData = []
          boxCount = 0;

          // Hide submit button since no query objects are on the canvas anymore
          var submitQueryButton = document.getElementById('submitQueryButton');
          submitQueryButton.style.visibility = "hidden";

          var resetButton = document.getElementById('resetButton');
          resetButton.style.visibility = "hidden";

          quitResultsDisplay(function() {console.log("qutting results display")});
          
          callback();
        }
     
        // MAIN functionality
        makeRegionDropdown();
        createInvisibleSearchButtons();


        });
    </script>