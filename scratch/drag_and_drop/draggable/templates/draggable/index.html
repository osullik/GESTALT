<!-- GESTALT-- _____ CENTRIC SEARCH-->

<!-- HTML & CSS (embedded in the <head>)-->

    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width">
        <title></title>
    
      <style>
        html {
        height: 100%;
        width: 100%; }
    
        h1 {
        color: white;
        background-color: black;
        margin: 0px; 
        font-size: 28px;
        font-family: monaco; }
    
        .background_container {
        display: flex; 
        height: 600px; }
    
        .brown_background_div {
        background-color: #DACD9F;
        width: 70%; }
    
       .green_background_div {
        background-color: #B2CD9F;
        width: 30%; }
    
        /* #searchTypeList {
        width: 300px;
        height: 30px;
        font-size: 15px;
        font-family: monaco;
        position: absolute; 
        top: 15px;
        left: 250px;
        background-color: grey; }
    
        .setSearchTypeButton {
        width: 100px;
        height: 30px;
        font-size: 15px;
        font-family: monaco;
        position: absolute; 
        top: 15px;
        left: 600px;
        background-color: grey; } */
    
        /* #objectNameList {
        width: 180px;
        height: 30px;
        font-size: 20px;
        font-family: monaco;
        position: absolute; 
        top: 100px;
        left: 1100px;
        background-color: grey; } */
    
        .dragBox {
        width: 150px;
        height: 70px;
        background-color: lightblue;
        position: absolute;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 15px;
        font-weight: bold; }
    
        #northButton {
        position: absolute;
        top: 20px;
        left: 1220px;
        color: white;
        font-size: 15px;
        font-family: monaco; }
    
        .northButtonLabel {
        position: absolute;
        top: 20px;
        left: 1250px;
        color: white;
        font-size: 15px;
        font-family: monaco; }

        #regionChoice{
        position: absolute;
        top: 80px;
        left: 100px;
        width: 400px;
        height: 50px;
        font-size: 20px;
        font-family: monaco;
        color: black; 
        visibility: hidden;}

        #regionButton{
        position: absolute;
        top: 80px;
        left: 530px;
        width: 120px;
        height: 50px;
        font-size: 20px;
        font-family: monaco;
        color: black; 
        visibility: hidden;}

        #objectChoice{
        position: absolute;
        top: 120px;
        left: 1000px;
        width: 200px;
        height: 30px;
        font-size: 15px;
        font-family: monaco;
        color: black; 
        visibility: hidden;}

        #objectButton{
        position: absolute;
        top: 120px;
        left: 1230px;
        width: 120px;
        height: 30px;
        font-size: 15px;
        font-family: monaco;
        color: black; 
        visibility: hidden;}

        #submitQueryButton{
        position: absolute;
        top: 250px;
        left: 1000px;
        width: 200px;
        height: 30px;
        font-size: 15px;
        font-family: monaco;
        color: green; 
        visibility: hidden;}

        #resetButton{
        position: absolute;
        top: 310px;
        left: 1000px;
        width: 200px;
        height: 30px;
        font-size: 15px;
        font-family: monaco;
        color: red; 
        visibility: hidden;}

        #objectSearchButton{
        position: absolute;
        top: 65px;
        left: 900px;
        width: 230px;
        font-size: 15px;
        font-family: monaco;
        background-color: green; 
        visibility: hidden;}
        
        #locationSearchButton{
        position: absolute;
        top: 65px;
        left: 1150px;
        width: 230px;
        font-size: 15px;
        font-family: monaco;
        background-color: white; 
        visibility: hidden;}

        .quadrantsDiv{
        position: absolute;
        top: 300px;
        left: 450px;
        font-size: 40px;
        font-family: monaco;
        visibility: hidden;}

        .resultsBoxDiv{
        position: absolute;
        top: 400px;
        left: 1075px;
        width: 400px;
        height: 200px;
        font-size: 15px;
        font-family: monaco;
        background-color: white;
        visibility: hidden;}

        #resultsXButton{
        position: absolute;
        top: 370px;
        left: 1480px;
        width: 20px;
        font-size: 15px;
        font-family: monaco;
        background-color: white; 
        visibility: hidden;}


      </style>
    
    </head>
    
    <body>
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    
        <h1>GESTALT - Geospatially Enhanced Search with Terrain Augmented Location Targeting </h1>
    
        <input type="checkbox" id="northButton" name="northButton" value="northButton" checked>
        <label for="northButton" class="northButtonLabel">I know the query's cardinal orientation</label>

        <div class="background_container">
          <div class="brown_background_div">
              <select name="regionChoice" id="regionChoice"></select>
              <button name="regionButton" id="regionButton">Set Region</button>
              
              <div class="quadrantsDiv" id="quadrantsDiv">+</div>
          </div> <!-- end brown-background-div -->
      
          <div class="green_background_div"> 
            <select name="objectChoice" id="objectChoice"></select>
            <button name="objectButton" id="objectButton">Add Object</button>
            <button name="submitQueryButton" id="submitQueryButton">Submit Query</button>
            <button name="resetButton" id="resetButton">Reset Canvas</button>
            <button name="objectSearchButton" id="objectSearchButton">Object-centric Search</button>
            <button name="locationSearchButton" id="locationSearchButton">Location-centric Search</button>
            <div class="resultsBoxDiv" id="resultsBoxDiv">Matching Locations:</div>
            <button name="resultsXButton" id="resultsXButton">X</button>
          </div> <!-- end green-background-div -->
      </div>  <!-- end background-container div -->
    
    </body>
    </html>
    
    <!-- JavaScript -->

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function(){
          var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
          var boxData = [];
          var objectQuery = {};
          var boxCount = 0;
          var searchType = "Object";
          var queryResponse = "";

          class Box {
                constructor(name, x, y) {
                    this.name = name;
                    this.x = x;
                    this.y = y;
                    this.element = this.createBoxElement();
                    this.attachEventListeners();
                    //this.updateCoordinates();
                }

                createBoxElement() {
                    var box = document.createElement('div');
                    box.classList.add('dragBox');
                    box.innerText = this.name + ': X: ' + this.x + ' Y: ' + this.y;
                    box.dataset.index = boxCount++;
                    document.body.appendChild(box);
                    return box;
                }

                attachEventListeners() {
                    var offsetX = 0;
                    var offsetY = 0;
                    var isDragging = false;

                    this.element.addEventListener('mousedown', (event) => {
                        offsetX = event.clientX - this.element.offsetLeft;
                        offsetY = event.clientY - this.element.offsetTop;
                        isDragging = true;
                    });

                    document.addEventListener('mousemove', (event) => {
                        if (isDragging) {
                            var x = event.clientX - offsetX;
                            var y = event.clientY - offsetY;
                            this.element.style.left = x + 'px';
                            this.element.style.top = y + 'px';

                            if (this.x === x && this.y === y) {return;}
                            this.x = x;
                            this.y = y;
                            //this.updateCoordinates();
                        }
                    });

                    document.addEventListener('mouseup', () => {
                        isDragging = false;
                        this.element.innerText = this.name + ': X: ' + this.x + ' Y: ' + this.y;
                    });
                }
              }

          function refreshPage() {
                location.reload();
          }

        function getRegions() {
          return $.ajax({
              type: 'GET',
              url: '/getregions/',
              success: function(response) {
                regions = response['regions'];
              }
            });
				}

        // region dropdown............
        function makeRegionDropdown() {
          getRegions().then(function(response) {
          console.log("Got these regions...");
          console.log(regions);				
       
          // Update the region dropdown menu
          var regionDropdown = document.getElementById('regionChoice');
          for (var i = 0; i < regions.length; i++) {
            var region = document.createElement('option');
            region.value = regions[i];
            region.text = regions[i];
            regionDropdown.add(region);
          }
          regionDropdown.style.visibility = "visible";
          
          // Add region GO button
          var regionButton = document.getElementById('regionButton');
          regionButton.addEventListener('click', 
            function (){
              makeQueryCanvas(document.getElementsByName('regionChoice')[0].value);
            });
          regionButton.addEventListener('click', () => regionButton.disabled = true);
          regionButton.addEventListener('click', enableSearchButtons);
          regionButton.style.visibility = "visible";
          })
				}  // ............region dropdown

        function makeQueryCanvas(regionChoice) {
          setRegion(displayObjDropdown, regionChoice);
				}
        function setRegion(callback, regionChoice) {
          $.ajax({
              type: 'POST',
              url: '/setregion/',
              data: {'name': regionChoice},
              beforeSend: function(xhr) {
                xhr.setRequestHeader('X-CSRFToken', csrfToken);
              },
              success: function(response) {
						  console.log("setregion done, selected...");
              console.log(regionChoice);
              callback(); // calls displayObjectDropdown
              }
          });
				}

        function displayObjDropdown() {
          getObjects(enableObjectSelect);
          createInvisibleSubmitButton();
          createInvisibleResetButton();
          createInvisibleSearchButtons();
          createInvisibleXButton();
				}
        function getObjects(callback) {
          $.ajax({
              type: 'GET',
              url: '/getobjs/',
              success: function(response) {
                objects = response['objects'];
                console.log(objects);
                callback(); // calls enableObjectSelect
              }
            });
				}

        function enableObjectSelect(callback) {
          // Update the object dropdown menu
          var objectDropdown = document.getElementById('objectChoice');
          for (var i = 0; i < objects.length; i++) {
            var object = document.createElement('option');
            object.value = objects[i];
            object.text = objects[i];
            objectDropdown.add(object);
          }
          objectDropdown.style.visibility = "visible";

          // Add object GO button
          var objectButton = document.getElementById('objectButton');
          objectButton.addEventListener('click', 
            function (){
              makeObject(function() {console.log("added")}, document.getElementsByName('objectChoice')[0].value);
            });
            objectButton.addEventListener('click', () => console.log("obj added"));
            objectButton.addEventListener('click', enableSubmitButton);
            objectButton.addEventListener('click', enableResetButton);
          objectButton.style.visibility = "visible";
				}

        function createInvisibleSubmitButton() {
          var submitQueryButton = document.getElementById('submitQueryButton');
          submitQueryButton.addEventListener('click', 
            function (){
              submitQuery(function() {console.log("query submit finished")});
            });
				}

        function enableSubmitButton(callback) {
          var submitQueryButton = document.getElementById('submitQueryButton');
          submitQueryButton.style.visibility = "visible";
				}

        function createInvisibleResetButton() {
          var resetButton = document.getElementById('resetButton');
          resetButton.addEventListener('click', 
            function (){
              reset(function() {console.log("reset finished")});
            });
				}

        function enableResetButton(callback) {
          var resetButton = document.getElementById('resetButton');
          resetButton.style.visibility = "visible";
				}

        function createInvisibleSearchButtons() {
          var objectSearchButton = document.getElementById('objectSearchButton');
          objectSearchButton.addEventListener('click', 
            function (){
              selectObjectSearch(function() {console.log("search type selection changed to OBJECT")});
            });

          var locationSearchButton = document.getElementById('locationSearchButton');
          locationSearchButton.addEventListener('click', 
            function (){
              selectLocationSearch(function() {console.log("search type selection changed to LOCATION")});
            });
				}

        function enableSearchButtons(callback) {
          var objectSearchButton = document.getElementById('objectSearchButton');
          var locationSearchButton = document.getElementById('locationSearchButton');
          objectSearchButton.style.visibility = "visible";
          locationSearchButton.style.visibility = "visible";
				}

        function selectObjectSearch(callback) {
          searchType = "Object";

          // Color buttons to show selection was made
          var objectSearchButton = document.getElementById('objectSearchButton');
          var locationSearchButton = document.getElementById('locationSearchButton');
          objectSearchButton.style.backgroundColor = "green";
          locationSearchButton.style.backgroundColor = "white";

          // Remove quadrants display
          var quadrantsDiv = document.getElementById('quadrantsDiv');
          quadrantsDiv.style.visibility = "hidden";

          // Allow cardinality choice
          var northButton = document.getElementById('northButton')
          northButton.disabled = false;
          callback();
        }

        function selectLocationSearch(callback) {
          searchType = "Location";

          // Color buttons to show selection was made
          var objectSearchButton = document.getElementById('objectSearchButton');
          var locationSearchButton = document.getElementById('locationSearchButton');
          objectSearchButton.style.backgroundColor = "white";
          locationSearchButton.style.backgroundColor = "green";

          // Display quadrants
          var quadrantsDiv = document.getElementById('quadrantsDiv');
          quadrantsDiv.style.visibility = "visible";

          // Force "knows cardinality" checked box to be checked
          var northButton = document.getElementById('northButton')
          northButton.checked = true;
          northButton.disabled = true;
          callback();
        }

        function makeObject(callback, objName) {
          console.log(objName);
          var newBox = new Box(objName, 0, 0);
          boxData.push(newBox);
				}

        function convertQuery(callback) {
          // Turn query boxData into a dictionary
          console.log("converting query")
          objectQuery = {};
          for (var i = 0; i < boxCount; i++) {
            objectQuery[i] = {
              'name':boxData[i].name,
              'x':boxData[i].x,
              'y':boxData[i].y
            };
				  }
          callback();
				}

        function submitQuery(callback) {
          convertQuery(function (){
            sendQuery(function (){
              getResponse(function (){
                showResponse(function (){console.log("got response")});
              });
            });
          });
        }
          
        function sendQuery(callback) { 
            $.ajax({type: 'POST',
                    url: '/setsearchparams/',
                    data: {
                      'object_query':JSON.stringify(objectQuery), 
                      'search_type': searchType, 
                      'knows_cardinality':document.getElementById('northButton').checked},
                    beforeSend: function(xhr) {
                      xhr.setRequestHeader('X-CSRFToken', csrfToken);
                    },
                    success: function(response) {
                      console.log("setsearchparams was successful")
                      console.log(searchType); // Either "Location" or "Object" 
                      console.log("User knows north setsearchparams: ", document.getElementById('northButton').checked);
                      console.log(objectQuery)
                      callback();
                    }
            });
          }

        function getResponse(callback) {
          console.log("query posted");
          $.ajax({
                  type: 'GET',
                  url: '/searchresult/',
                  success: function(response) {
                    queryResponse = response.locations;
                    console.log("searchresult is")
                    console.log(queryResponse); // Print the box data
                    callback();
                  }
					});
        }

        function createInvisibleXButton() {
          var resultsXButton = document.getElementById('resultsXButton');
          resultsXButton.addEventListener('click', 
            function (){
              quitResultsDisplay(function() {console.log("results cleared")});
            }
          );
				}

        function quitResultsDisplay(callback) {
          var resultsBoxDiv = document.getElementById('resultsBoxDiv');
          resultsBoxDiv.style.visibility = "hidden";

          var resultsXButton = document.getElementById('resultsXButton');
          resultsXButton.style.visibility = "hidden";
          callback();
        }

        function showResponse(callback) {
          // Results display panel
          var resultsBoxDiv = document.getElementById('resultsBoxDiv');
          var resultsString = "Locations matching query configuration: \n";
						for (i in queryResponse) {
						  resultsString = resultsString.concat(queryResponse[i]);
              resultsString = resultsString.concat("\n");
						}
          resultsBoxDiv.innerText = resultsString;
          resultsBoxDiv.style.visibility = "visible";

          // X to close results display
          var resultsXButton = document.getElementById('resultsXButton');
          resultsXButton.style.visibility = "visible";
          callback();
				}

          
        

        function reset(callback) {
          console.log("resetting....");
          for (var i = 0; i < boxCount; i++) {
            boxData[i].element.style.visibility = "hidden";
				  }
          boxData = []
          boxCount = 0;

          // Hide submit button since no query objects are on the canvas anymore
          var submitQueryButton = document.getElementById('submitQueryButton');
          submitQueryButton.style.visibility = "hidden";
          callback();
        }
     
        // MAIN functionality
        makeRegionDropdown();

        });
    </script>