<!-- GESTALT-- _____ CENTRIC SEARCH-->

<!-- HTML & CSS (embedded in the <head>)-->

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title></title>

  <style>
    html {
    height: 100%;
    width: 100%; }

    h1 {
    color: white;
    background-color: black;
    margin: 0px; 
    font-family: monaco; }

    .background_container {
    display: flex; 
    height: 600px; }

    .brown_background_div {
    background-color: #DACD9F;
    width: 70%; }

   .green_background_div {
    background-color: #B2CD9F;
    width: 30%; }

    #searchTypeList {
    width: 300px;
    height: 30px;
    font-size: 15px;
    font-family: monaco;
    position: absolute; 
    top: 15px;
    left: 250px;
    background-color: grey; }

    .setSearchTypeButton {
    width: 100px;
    height: 30px;
    font-size: 15px;
    font-family: monaco;
    position: absolute; 
    top: 15px;
    left: 600px;
    background-color: grey; }

    #objectNameList {
    width: 180px;
    height: 30px;
    font-size: 20px;
    font-family: monaco;
    position: absolute; 
    top: 100px;
    left: 1100px;
    background-color: grey; }

    .dragBox {
    width: 150px;
    height: 70px;
    background-color: lightblue;
    position: absolute;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 15px;
    font-weight: bold; }

    #northButton {
    position: absolute;
    top: 20px;
    left: 1305px;
    color: white;
    font-size: 15px;
    font-family: monaco; }

    .northButtonLabel {
    position: absolute;
    top: 20px;
    left: 1110px;
    color: white;
    font-size: 15px;
    font-family: monaco; }

  </style>

</head>

<body>
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

    <h1>GESTALT - </h1>

    <input type="checkbox" id="northButton" name="northButton" value="northButton" checked>
    <label for="northButton" class="northButtonLabel">I know where North is</label>

    <div class="background_container">

    <div class="brown_background_div"> 

    </div> <!-- end brown-background-div -->

    <div class="green_background_div"> 
        <select id="objectNameList" name="objectNameList">
            <option value="Object1">Object1</option>
            <option value="Object2">Object2</option>
            <option value="Object3">Object3</option>
        </select>
    </div> <!-- end green-background-div -->
 </div>  <!-- end background-container div -->

</body>
</html>

<!-- JavaScript -->

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            var boxData = [];
            var boxCount = 0;  // Initial box count
            var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            class Box {
                constructor(name, x, y) {
                    this.name = name;
                    this.x = x;
                    this.y = y;
                    this.element = this.createBoxElement();
                    this.attachEventListeners();
                    this.updateCoordinates();
                }

                createBoxElement() {
                    var box = document.createElement('div');
                    box.classList.add('dragBox');
                    box.innerText = this.name + ': X: ' + this.x + ' Y: ' + this.y;
                    box.dataset.index = boxCount++;
                    document.body.appendChild(box);
                    return box;
                }

                attachEventListeners() {
                    var offsetX = 0;
                    var offsetY = 0;
                    var isDragging = false;

                    this.element.addEventListener('mousedown', (event) => {
                        offsetX = event.clientX - this.element.offsetLeft;
                        offsetY = event.clientY - this.element.offsetTop;
                        isDragging = true;
                    });

                    document.addEventListener('mousemove', (event) => {
                        if (isDragging) {
                            var x = event.clientX - offsetX;
                            var y = event.clientY - offsetY;
                            this.element.style.left = x + 'px';
                            this.element.style.top = y + 'px';

                            if (this.x === x && this.y === y) {
                                return;
                            }

                            this.x = x;
                            this.y = y;
                            this.updateCoordinates();
                        }
                    });

                    document.addEventListener('mouseup', () => {
                        isDragging = false;
                    });
                }

                updateCoordinates() {
                    var self = this;  // Preserve the reference to the current box object

                    $.ajax({
                        type: 'POST',
                        url: '/coordinates/',
                        data: { 'index': self.element.dataset.index, 'name': self.name, 'x': self.x, 'y': self.y },
                        beforeSend: function(xhr) {
                            xhr.setRequestHeader('X-CSRFToken', csrfToken);
                        },
                        success: function(response) {
                            self.element.innerText = self.name;
                            self.x = response.x;
                            self.y = response.y;
                        }
                    });
                }
            }

            function addBox() {
                var objectNameList = document.getElementById('objectNameList');
                var selectedIndex = objectNameList.selectedIndex;
                
                var selectedOption = objectNameList.options[selectedIndex];
                console.log(selectedOption);
        
                var newBox = new Box(selectedOption.value, 0, 0);
                boxData.push(newBox);  
            }

            function submitQuery() {
                $.ajax({
                    type: 'GET',
                    url: '/boxdata/',
                    success: function(response) {
                        var boxData = response.box_data;
                        console.log(boxData); // Print the box data in the browser console
                        // Perform further processing with the box data as desired
                        console.log(searchType);
                        //Prints either "Location" or "Object" to the console depending on the
                                //search type the user chooses to use
                        console.log(userKnowsNorth);
                        //Prints either "Does not know where North is" or "Knows where North is" to
                                //the console depending on the user's selection of the checkbox
						
						// for (i in boxData) { alert(boxData[i].name); }  THIS DISPLAYS the objs

                        //The code below appends a pop-up box to the screen once the user hits Run Query:
                        //Replace the "filler text" with the produced results from the search
                    }
                });
				
				$.ajax({
                    type: 'GET',
                    url: '/searchresult/',
                    success: function(response) {
                        var locationData = response.locations;
                        console.log(locationData); // Print the box data in the browser console
                        // Perform further processing with the box data as desired
                        console.log(searchType);
                        //Prints either "Location" or "Object" to the console depending on the
                                //search type the user chooses to use
                        console.log(userKnowsNorth);
                        //Prints either "Does not know where North is" or "Knows where North is" to
                                //the console depending on the user's selection of the checkbox
						
						var resultsString = "Locations matching query configuration: \n";
						for (i in locationData) {
						resultsString = resultsString.concat(locationData[i])
						//alert(locationData[i]); 
						} //alert(locationData)
						resultsDisplay.innerText = resultsString
						document.body.appendChild(resultsDisplay);
                        document.body.appendChild(quitResultsDisplay);
                    }
                });
            }

            function refreshPage() {
                location.reload();
            }

            var userKnowsNorth = "Knows where North is";
            var container = $(".brown_background_div");
            var northArrow = document.createElement('string');
            document.body.appendChild(northArrow);
            northArrow.textContent = "North â‡‘";
            northArrow.style.fontSize = "40px";
            northArrow.style.fontWeight = 'bold';
            northArrow.style.color = 'black';
            northArrow.style.position = 'absolute';
            northArrow.style.left = '900px';
            northArrow.style.top = "70px";

            let northCheckbox = document.getElementById("northButton");
            northCheckbox.addEventListener( "change", () => {
              if (searchType === "Object") {
                if (northCheckbox.checked ) {
                    userKnowsNorth = "Knows where North is";
                    container.append(northArrow);
                } else {
                    userKnowsNorth = "Does not know where North is";
                    if (northArrow){
                        northArrow.parentNode.removeChild(northArrow);
                    } 
                }
              } else { //if (searchType === "Location")
                if (northCheckbox.checked) {
                    userKnowsNorth = "Knows where North is";
                    container.append(northArrow);
                } else {
                    userKnowsNorth = "Knows where North is";
                    alert("North must be known in order to run the location-centric search.");
                    northCheckbox.checked = true;
                }
              }
            });
    

            var addButton = document.createElement('button');
            addButton.innerText = 'Add Selected Object to Search';
            addButton.addEventListener('click', addBox);
            document.body.appendChild(addButton);
            addButton.style.position = "absolute";
            addButton.style.top = "190px";
            addButton.style.left = "1100px";
            addButton.style.width = "200px";
            addButton.style.fontSize = "15px";
            addButton.style.fontFamily = "monaco";

            var submitButton = document.createElement('button');
            submitButton.innerText = 'Submit Query';
            submitButton.addEventListener('click', submitQuery);
            document.body.appendChild(submitButton);
            submitButton.style.position = "absolute";
            submitButton.style.top = "250px";
            submitButton.style.left = "1100px";
            submitButton.style.width = "200px";
            submitButton.style.fontSize = "15px";
            submitButton.style.fontFamily = "monaco";
            submitButton.style.color = "green";

            var resetButton = document.createElement('button');
            resetButton.innerText = "RESET";
            resetButton.addEventListener('click', refreshPage);
            document.body.appendChild(resetButton);
            resetButton.style.position = "absolute";
            resetButton.style.top = "310px";
            resetButton.style.left = "1100px";
            resetButton.style.width = "200px";
            resetButton.style.fontSize = "15px";
            resetButton.style.fontFamily = "monaco";
            resetButton.style.color = "red";

            var searchType = "Object";

            var objectCentricSearchButton = document.createElement('button');
            objectCentricSearchButton.innerText = "Object Centric Search";
            objectCentricSearchButton.addEventListener('click', function() {
                refreshPage();
                searchType = "Object";
            });
            document.body.appendChild(objectCentricSearchButton);
            objectCentricSearchButton.style.position = "absolute";
            objectCentricSearchButton.style.top = "15px";
            objectCentricSearchButton.style.left = "300px";
            objectCentricSearchButton.style.width = "250px";
            objectCentricSearchButton.style.fontSize = "15px";
            objectCentricSearchButton.style.fontFamily = "monaco";
            objectCentricSearchButton.style.backgroundColor = "green";

            var locationCentricSearchButton = document.createElement('button');
            locationCentricSearchButton.innerText = "Location Centric Search";
            locationCentricSearchButton.addEventListener('click', function() {
                searchType = "Location";

                container.append(northArrow);
                northCheckbox.checked = true;
                userKnowsNorth = "Knows where North is";

                var compass = document.createElement("div");
                compass.textContent = "+";
                compass.style.position = "absolute";
                compass.style.top = "300px";
                compass.style.left = "450px";
                compass.style.fontSize = "40px";
                document.body.appendChild(compass);
                locationCentricSearchButton.style.backgroundColor = "green";
                objectCentricSearchButton.style.backgroundColor = "white";
            });
            document.body.appendChild(locationCentricSearchButton);
            locationCentricSearchButton.style.position = "absolute";
            locationCentricSearchButton.style.top = "15px";
            locationCentricSearchButton.style.left = "600px";
            locationCentricSearchButton.style.width = "250px";
            locationCentricSearchButton.style.fontSize = "15px";
            locationCentricSearchButton.style.fontFamily = "monaco";

            var resultsDisplay = document.createElement('div');
            resultsDisplay.style.backgroundColor = "#e7efee";
            resultsDisplay.style.width = "400px";
            resultsDisplay.style.height = "200px";
            resultsDisplay.style.position = "absolute";
            resultsDisplay.style.top = "400px";
            resultsDisplay.style.left = "1075px";

            var quitResultsDisplay = document.createElement('button');
            quitResultsDisplay.innerText = "X";
            quitResultsDisplay.style.fontSize = "20px";
            quitResultsDisplay.style.position = "absolute";
            quitResultsDisplay.style.top = "370px";
            quitResultsDisplay.style.left = "1480px";
            quitResultsDisplay.addEventListener('click', refreshPage);

        });

    </script>